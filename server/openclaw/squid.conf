# Squid Proxy — Egress Spoke Configuration
# Deny-by-default: only allowlisted domains pass.
# Deploy to /etc/squid/squid.conf on the droplet.
#
# Install: apt install squid
# Restart: systemctl restart squid

# ─── ACLs ───────────────────────────────────────────────────────────

# Allowlisted domains (from v3 Section 9 Tier 3)
acl allowed_domains dstdomain .api.anthropic.com
acl allowed_domains dstdomain .api.twilio.com
acl allowed_domains dstdomain .gmail.googleapis.com
acl allowed_domains dstdomain .calendar.googleapis.com
acl allowed_domains dstdomain .www.googleapis.com
acl allowed_domains dstdomain .proapi.whitepages.com
acl allowed_domains dstdomain .api.openphone.com
acl allowed_domains dstdomain .api.intuit.com
acl allowed_domains dstdomain .api.mailchimp.com
acl allowed_domains dstdomain .api.telegram.org
acl allowed_domains dstdomain .github.com
acl allowed_domains dstdomain .registry.npmjs.org
acl allowed_domains dstdomain .api.perplexity.ai

# Hard-blocked Chinese AI model providers
acl blocked_domains dstdomain .api.deepseek.com
acl blocked_domains dstdomain .dashscope.aliyuncs.com
acl blocked_domains dstdomain .api.moonshot.cn
acl blocked_domains dstdomain .open.bigmodel.cn
acl blocked_domains dstdomain .api.doubao.com
acl blocked_domains dstdomain .aip.baidubce.com
acl blocked_domains dstdomain .api.minimax.chat
acl blocked_domains dstdomain .api.baichuan-ai.com
acl blocked_domains dstdomain .api.lingyiwanwu.com
acl blocked_domains dstdomain .api.mimo.ai

# Standard Squid ACLs
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT

# ─── Access Rules ───────────────────────────────────────────────────

# Block non-safe ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Hard block Chinese AI providers (explicit deny before allow)
http_access deny blocked_domains

# Allow only whitelisted domains
http_access allow allowed_domains

# Deny everything else (deny-by-default)
http_access deny all

# ─── Proxy Settings ────────────────────────────────────────────────

# Listen on localhost only (OpenClaw connects locally)
http_port 127.0.0.1:3128

# Disable caching (API traffic shouldn't be cached)
cache deny all

# Minimal logging
access_log daemon:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# Hide proxy headers from upstream
via off
forwarded_for delete
