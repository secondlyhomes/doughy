name: Deploy to Production

# Production deployment workflow
# Triggered by version tags (v1.0.0, v1.2.3, etc.)
# Includes manual approval gates and comprehensive validation

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.0.0)'
        required: true
      skip_store_submission:
        description: 'Skip app store submission'
        required: false
        type: boolean
        default: false
      skip_approval:
        description: 'Skip approval gate (emergency only)'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  EXPO_VERSION: 'latest'
  EAS_VERSION: 'latest'
  ENVIRONMENT: 'production'

jobs:
  # ====================
  # Pre-deployment validation
  # ====================

  pre-deploy-validation:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate version tag
        if: github.event_name == 'push'
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}

          echo "Tag: $TAG"
          echo "Version: $VERSION"

          # Validate semantic version format
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            echo "Expected format: v1.2.3"
            exit 1
          fi

          # Check if version matches package.json
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if [ "$VERSION" != "$PACKAGE_VERSION" ]; then
            echo "::error::Version mismatch!"
            echo "Tag version: $VERSION"
            echo "package.json version: $PACKAGE_VERSION"
            exit 1
          fi

          echo "✓ Version validation passed"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Run comprehensive tests
        run: |
          echo "Running full test suite..."
          npm run lint
          npx tsc --noEmit
          npm run test:ci
          npm run test:integration

      - name: Run security audit
        run: |
          npm audit --audit-level=high
          node scripts/check-secrets.js

      - name: Validate production configuration
        run: |
          echo "Validating production configuration..."
          node scripts/ci/validate-production-config.js
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_PRODUCTION_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_PRODUCTION_ANON_KEY }}

      - name: Check database migrations
        run: |
          echo "Checking database migration status..."
          node scripts/db/migrate.js status
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_PRODUCTION_URL }}
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_PRODUCTION_SECRET_KEY }}

      - name: Generate deployment checklist
        run: |
          echo "# Production Deployment Checklist" > deployment-checklist.md
          echo "" >> deployment-checklist.md
          echo "- [x] Version tag validated" >> deployment-checklist.md
          echo "- [x] All tests passed" >> deployment-checklist.md
          echo "- [x] Security audit passed" >> deployment-checklist.md
          echo "- [x] Configuration validated" >> deployment-checklist.md
          echo "- [x] Database migrations verified" >> deployment-checklist.md

      - name: Upload deployment checklist
        uses: actions/upload-artifact@v4
        with:
          name: deployment-checklist
          path: deployment-checklist.md
          retention-days: 90

  # ====================
  # Manual Approval Gate
  # ====================

  approval-gate:
    name: Deployment Approval
    needs: pre-deploy-validation
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_approval }}
    environment:
      name: production-approval
      url: https://app.yourapp.com
    timeout-minutes: 1440  # 24 hours

    steps:
      - name: Wait for approval
        run: |
          echo "⏳ Waiting for production deployment approval..."
          echo "This deployment requires manual approval from authorized personnel."

      - name: Approval received
        run: |
          echo "✅ Production deployment approved"
          echo "Proceeding with deployment..."

  # ====================
  # Database Migration
  # ====================

  database-migration:
    name: Database Migration
    needs: [pre-deploy-validation, approval-gate]
    if: ${{ !failure() && !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Backup database
        run: |
          echo "Creating database backup..."
          BACKUP_NAME="pre-deployment-$(date +%Y%m%d-%H%M%S)"
          echo "Backup name: $BACKUP_NAME"
          # Add your backup logic here
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_PRODUCTION_URL }}
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_PRODUCTION_SECRET_KEY }}

      - name: Run migrations
        run: |
          echo "Running database migrations..."
          node scripts/db/migrate.js
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_PRODUCTION_URL }}
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_PRODUCTION_SECRET_KEY }}
          ENVIRONMENT: production

      - name: Verify migrations
        run: |
          echo "Verifying database state..."
          node scripts/db/migrate.js status
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_PRODUCTION_URL }}
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_PRODUCTION_SECRET_KEY }}

  # ====================
  # Build Production Apps
  # ====================

  build-production-ios:
    name: Build iOS (Production)
    needs: [database-migration]
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: ${{ env.EXPO_VERSION }}
          eas-version: ${{ env.EAS_VERSION }}
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Prepare production configuration
        run: |
          echo "Preparing iOS production configuration..."
          node scripts/ci/prepare-production-config.js
        env:
          PLATFORM: ios
          ENVIRONMENT: production
          SUPABASE_URL: ${{ secrets.SUPABASE_PRODUCTION_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_PRODUCTION_ANON_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN_PRODUCTION }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

      - name: Build iOS production
        id: build
        run: |
          eas build \
            --platform ios \
            --profile production \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-production-build
          path: |
            *.ipa
          retention-days: 90

  build-production-android:
    name: Build Android (Production)
    needs: [database-migration]
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: ${{ env.EXPO_VERSION }}
          eas-version: ${{ env.EAS_VERSION }}
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Prepare production configuration
        run: |
          echo "Preparing Android production configuration..."
          node scripts/ci/prepare-production-config.js
        env:
          PLATFORM: android
          ENVIRONMENT: production
          SUPABASE_URL: ${{ secrets.SUPABASE_PRODUCTION_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_PRODUCTION_ANON_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN_PRODUCTION }}

      - name: Build Android production (AAB)
        id: build-aab
        run: |
          eas build \
            --platform android \
            --profile production \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Build Android production (APK)
        id: build-apk
        run: |
          eas build \
            --platform android \
            --profile production-apk \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-production-build
          path: |
            *.aab
            *.apk
          retention-days: 90

  # ====================
  # Submit to App Stores
  # ====================

  submit-ios:
    name: Submit to App Store
    needs: build-production-ios
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_store_submission }}
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: ${{ env.EXPO_VERSION }}
          eas-version: ${{ env.EAS_VERSION }}
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to App Store
        run: |
          eas submit \
            --platform ios \
            --latest \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

      - name: Check submission status
        run: |
          echo "App Store submission initiated"
          echo "Check status at: https://appstoreconnect.apple.com"

  submit-android:
    name: Submit to Play Store
    needs: build-production-android
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_store_submission }}
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: ${{ env.EXPO_VERSION }}
          eas-version: ${{ env.EAS_VERSION }}
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to Play Store
        run: |
          eas submit \
            --platform android \
            --latest \
            --track internal \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_ANDROID_SERVICE_ACCOUNT_KEY_PATH: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}

      - name: Check submission status
        run: |
          echo "Play Store submission initiated (internal track)"
          echo "Check status at: https://play.google.com/console"

  # ====================
  # OTA Update
  # ====================

  publish-ota-production:
    name: Publish OTA Update
    needs: [build-production-ios, build-production-android]
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: ${{ env.EXPO_VERSION }}
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Publish OTA update to production
        run: |
          npx eas update \
            --branch production \
            --message "Production release ${{ env.VERSION }}" \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Verify update
        run: |
          echo "OTA update published to production channel"
          npx eas update:list --branch production --limit 1

  # ====================
  # Post-deployment Tests
  # ====================

  production-smoke-tests:
    name: Production Smoke Tests
    needs: [publish-ota-production]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run production smoke tests
        run: node scripts/ci/smoke-tests.js
        env:
          ENVIRONMENT: production
          API_URL: ${{ secrets.SUPABASE_PRODUCTION_URL }}
          API_KEY: ${{ secrets.SUPABASE_PRODUCTION_ANON_KEY }}

      - name: Test critical endpoints
        run: |
          echo "Testing production endpoints..."
          curl -f ${{ secrets.SUPABASE_PRODUCTION_URL }}/rest/v1/ \
            -H "apikey: ${{ secrets.SUPABASE_PRODUCTION_ANON_KEY }}" || exit 1

      - name: Verify authentication
        run: |
          echo "Testing authentication flow..."
          # Add authentication tests here

  # ====================
  # Create GitHub Release
  # ====================

  create-release:
    name: Create GitHub Release
    needs:
      - build-production-ios
      - build-production-android
      - publish-ota-production
      - production-smoke-tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate changelog
        id: changelog
        run: |
          node scripts/generate-changelog.js > RELEASE_NOTES.md
          cat RELEASE_NOTES.md

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md
          retention-days: 365

  # ====================
  # Monitoring Setup
  # ====================

  setup-monitoring:
    name: Setup Production Monitoring
    needs: production-smoke-tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create Sentry release
        run: |
          npx sentry-cli releases new "${{ github.ref_name }}"
          npx sentry-cli releases set-commits "${{ github.ref_name }}" --auto
          npx sentry-cli releases finalize "${{ github.ref_name }}"
          npx sentry-cli releases deploys "${{ github.ref_name }}" new -e production
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

      - name: Configure monitoring alerts
        run: |
          echo "Setting up production monitoring..."
          node scripts/ci/setup-monitoring.js
        env:
          ENVIRONMENT: production
          SENTRY_DSN: ${{ secrets.SENTRY_DSN_PRODUCTION }}

  # ====================
  # Notifications
  # ====================

  notify-deployment:
    name: Send Deployment Notifications
    needs:
      - build-production-ios
      - build-production-android
      - publish-ota-production
      - production-smoke-tests
      - create-release
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine deployment status
        id: status
        run: |
          if [ "${{ needs.build-production-ios.result }}" == "success" ] && \
             [ "${{ needs.build-production-android.result }}" == "success" ] && \
             [ "${{ needs.publish-ota-production.result }}" == "success" ] && \
             [ "${{ needs.production-smoke-tests.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=✅" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=❌" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        run: node scripts/ci/notify.js
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DEPLOYMENT_STATUS: ${{ steps.status.outputs.status }}
          ENVIRONMENT: production
          VERSION: ${{ github.ref_name }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          AUTHOR: ${{ github.actor }}

      - name: Send email notification
        if: steps.status.outputs.status == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: Production Deployment Successful - ${{ github.ref_name }}
          body: |
            Production deployment completed successfully!

            Version: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}

            View release: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
          to: team@yourcompany.com
          from: CI/CD <noreply@yourcompany.com>

      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              required_contexts: [],
              auto_merge: false,
              production_environment: true
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: '${{ steps.status.outputs.status }}',
              environment_url: 'https://app.yourapp.com',
              description: 'Production deployment ${{ steps.status.outputs.status }}'
            });
