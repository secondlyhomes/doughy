name: Deploy

on:
  push:
    branches: [main, develop]

jobs:
  # ============================================
  # STAGING DEPLOYMENT (develop branch)
  # Deploys to:
  #   - Supabase (lqmbyobweeaigrwmvizo)
  #   - TestFlight (internal testers)
  #   - Google Play (internal track)
  #   - Netlify (staging URL)
  # ============================================
  deploy-staging:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - run: npm ci

      # ---- Supabase ----
      - uses: supabase/setup-cli@v1
      - name: Deploy Supabase (Staging)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ vars.SUPABASE_PROJECT_ID }}
        run: |
          echo "Deploying migrations..."
          supabase db push --project-ref "$SUPABASE_PROJECT_ID"
          echo "Deploying edge functions..."
          supabase functions deploy --project-ref "$SUPABASE_PROJECT_ID"

      # ---- Mobile Apps ----
      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build iOS (TestFlight - Internal)
        run: eas build --platform ios --profile staging --non-interactive --no-wait

      - name: Build Android (Play Store - Internal)
        run: eas build --platform android --profile staging --non-interactive --no-wait

      # ---- Web ----
      - name: Build Web
        run: npm run build:web
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ vars.SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

      - name: Deploy to Netlify (Staging)
        uses: netlify/actions/cli@master
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ vars.NETLIFY_SITE_ID }}
        with:
          args: deploy --dir=dist --message "Staging deploy"

  # ============================================
  # PRODUCTION DEPLOYMENT (main branch)
  # Deploys to:
  #   - Supabase (vpqglbaedcpeprnlnfxd)
  #   - App Store (via TestFlight â†’ manual review)
  #   - Google Play (production track)
  #   - Netlify (production URL)
  # ============================================
  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production # Requires approval in GitHub settings
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - run: npm ci

      # ---- Supabase ----
      - uses: supabase/setup-cli@v1
      - name: Deploy Supabase (Production)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ vars.SUPABASE_PROJECT_ID }}
        run: |
          echo "PRODUCTION DEPLOYMENT"
          echo "Deploying migrations..."
          supabase db push --project-ref "$SUPABASE_PROJECT_ID"
          echo "Deploying edge functions..."
          supabase functions deploy --project-ref "$SUPABASE_PROJECT_ID"

      # ---- Mobile Apps ----
      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build & Submit iOS
        run: |
          eas build --platform ios --profile production --non-interactive
          eas submit --platform ios --profile production --latest --non-interactive

      - name: Build & Submit Android
        run: |
          eas build --platform android --profile production --non-interactive
          eas submit --platform android --profile production --latest --non-interactive

      # ---- Web ----
      - name: Build Web
        run: npm run build:web
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ vars.SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

      - name: Deploy to Netlify (Production)
        uses: netlify/actions/cli@master
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ vars.NETLIFY_SITE_ID }}
        with:
          args: deploy --dir=dist --prod --message "Production deploy"
